<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Analisis Penjualan Buku Gramedia Purwakarta – Kolaborasi UPI Purwakarta</title>
    <meta name="description"
        content="Website ringkas untuk mempresentasikan analisis penjualan Gramedia Purwakarta dengan kesimpulan otomatis dan rekomendasi kolaborasi UPI Purwakarta." />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0b0e14;
            --card: #11151d;
            --muted: #8a93a6;
            --text: #e9edf6;
            --brand: #5aa2ff;
            --accent: #41d3bd;
            --border: #1b2230;
            --ring: #2a3245;
        }

        @media (prefers-color-scheme: light) {
            :root {
                --bg: #f7f9fc;
                --card: #ffffff;
                --muted: #5b657a;
                --text: #0a0e17;
                --brand: #2458d9;
                --accent: #0aa37f;
                --border: #e6e9f0;
                --ring: #e7ecf8;
            }
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            font-family: Inter, system-ui, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.55
        }

        a {
            color: var(--brand);
            text-decoration: none
        }

        a:hover {
            text-decoration: underline
        }

        /* Header */
        .header {
            position: sticky;
            top: 0;
            z-index: 50;
            background: linear-gradient(180deg, rgba(0, 0, 0, .25), rgba(0, 0, 0, 0)), var(--card);
            border-bottom: 1px solid var(--border);
            backdrop-filter: saturate(1.1) blur(6px)
        }

        .nav {
            max-width: 1100px;
            margin: 0 auto;
            padding: 14px 18px;
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: space-between
        }

        .nav .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700
        }

        .nav .brand .dot {
            width: 10px;
            height: 10px;
            border-radius: 999px;
            background: linear-gradient(135deg, var(--brand), var(--accent))
        }

        .nav a.btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: transparent
        }

        .nav a.btn:hover {
            background: var(--ring);
            text-decoration: none
        }

        /* 📱 Mobile: sembunyikan tombol navigasi, sisakan logo + judul */
        @media (max-width: 640px) {
            .nav {
                padding: 10px 14px;
            }

            .nav .brand .dot {
                width: 8px;
                height: 8px;
            }

            .nav .brand span {
                font-size: 14px;
                font-weight: 700;
            }

            .nav .row {
                display: none;
            }

            /* nav links disembunyikan */
        }

        /* 📲 Tablet kecil: perkecil tombol navigasi */
        @media (min-width: 641px) and (max-width: 880px) {
            .nav a.btn {
                padding: 6px 10px;
                font-size: 13px;
                border-radius: 10px;
            }
        }

        /* Hero & layout */
        .hero {
            max-width: 1100px;
            margin: 24px auto 8px;
            padding: 0 18px 8px;
            display: grid;
            gap: 18px
        }

        .hero h1 {
            font-size: clamp(24px, 5vw, 34px);
            line-height: 1.15;
            margin: 6px 0
        }

        .hero p {
            color: var(--muted);
            margin: 0
        }

        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px
        }

        .tag {
            font-size: 12px;
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 999px;
            color: var(--muted);
            background: linear-gradient(180deg, rgba(255, 255, 255, .02), rgba(0, 0, 0, .03))
        }

        .container {
            max-width: 1100px;
            margin: 8px auto 60px;
            padding: 0 18px
        }

        .section {
            margin-top: 22px
        }

        .section h2 {
            font-size: clamp(18px, 4vw, 24px);
            margin: 0 0 12px;
            display: flex;
            align-items: center;
            gap: 10px
        }

        .section h2 .bar {
            width: 8px;
            height: 22px;
            border-radius: 4px;
            background: linear-gradient(180deg, var(--brand), var(--accent))
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 18px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, .12)
        }

        .grid {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr))
        }

        .chart-box {
            position: relative;
            width: 100%;
            height: 320px;
            border: 1px dashed var(--ring);
            border-radius: 14px;
            padding: 8px;
            background: linear-gradient(180deg, rgba(255, 255, 255, .03), rgba(0, 0, 0, .04))
        }

        @media (min-width:980px) {
            .chart-box {
                height: 360px
            }
        }

        .q-card header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 14px;
            margin-bottom: 8px
        }

        .q-title {
            font-weight: 700;
            font-size: 18px;
            margin: 0
        }

        .q-desc {
            color: var(--muted);
            font-size: 14px;
            margin-top: 6px
        }

        .q-meta {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px
        }

        .pill {
            font-size: 12px;
            padding: 5px 9px;
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--muted)
        }

        .insight {
            margin-top: 10px;
            border-top: 1px dashed var(--border);
            padding-top: 10px;
            background: linear-gradient(180deg, rgba(255, 255, 255, .02), rgba(0, 0, 0, .02));
            border-radius: 10px
        }

        .insight b {
            color: var(--accent)
        }

        .muted {
            color: var(--muted)
        }

        footer {
            color: var(--muted);
            text-align: center;
            margin: 34px 0
        }

        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center
        }

        .kbd {
            font-variant: all-small-caps;
            letter-spacing: .3px;
            font-weight: 700
        }

        /* Upload panel */
        .upload {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-top: 8px
        }

        .upload .btn {
            cursor: pointer
        }

        .help {
            font-size: 13px;
            color: var(--muted);
            margin-top: 6px
        }

        .mini {
            font-size: 12px;
            color: var(--muted)
        }

        .ok {
            color: var(--accent);
            font-weight: 600
        }

        .warn {
            color: #f0a500;
            font-weight: 600
        }

        /* Table (UPI) */
        .table-wrap {
            overflow-x: auto;
            margin-top: 10px;
            border: 1px solid var(--border);
            border-radius: 12px
        }

        table.tbl {
            width: 100%;
            border-collapse: collapse;
            min-width: 780px;
            background: linear-gradient(180deg, rgba(255, 255, 255, .02), rgba(0, 0, 0, .02))
        }

        .tbl th,
        .tbl td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            vertical-align: top
        }

        .tbl th {
            background: var(--card);
            position: sticky;
            top: 0;
            text-align: left;
            color: var(--muted);
            font-weight: 600
        }

        .tbl tr:hover td {
            background: rgba(255, 255, 255, .02)
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav">
            <div class="brand">
                <div class="dot" aria-hidden="true"></div><span>Analisis Penjualan Gramedia Purwakarta</span>
            </div>
            <div class="row">
                <a class="btn" href="#latar">Latar Belakang</a>
                <a class="btn" href="#pb">PB Umum</a>
                <a class="btn" href="#pb-upi">PB UPI</a>
                <a class="btn" href="#kesimpulan">Kesimpulan</a>
                <a class="btn" href="#upi">UPI</a>
            </div>
        </nav>
    </header>

    <!-- Hero -->
    <section class="hero">
        <div>
            <h1>Analisis Penjualan Buku – Perspektif Kolaborasi UPI Purwakarta</h1>
            <p class="muted">Ringkasan visual hasil notebook analisis.</p>
            <div class="tags">
                <span class="tag">Retail Books</span><span class="tag">Gramedia Purwakarta</span><span class="tag">UPI
                    Purwakarta</span><span class="tag">Business Insight</span>
            </div>
            <!-- Upload Panel -->
            <div class="upload">
                <input id="fileInput" type="file" multiple accept=".json,.csv" />
                <button id="btnUseSample" class="btn"
                    style="border:1px solid var(--border);border-radius:10px;padding:8px 12px;background:transparent">Gunakan
                    Data Contoh</button>
                <span id="uploadStatus" class="mini">Unggah satu berkas JSON (berbentuk <code>DATA</code>) atau beberapa
                    CSV: <em>kategori.csv</em>, <em>bulanan.csv</em>, <em>topItem.csv</em>, <em>penerbit.csv</em>,
                    <em>weekday.csv</em>, <em>priceBands.csv</em>, <em>bulananPromo.csv</em>.</span>
            </div>
            <div class="help">
                <b>Format CSV:</b> header wajib sesuai dataset.<br>
                <code>kategori: nama, penjualan</code> ·
                <code>bulanan: bulan(YYYY-MM), penjualan</code> ·
                <code>topItem: label, penjualan</code> ·
                <code>penerbit: nama, penjualan</code> ·
                <code>weekday: hari(Sen..Min), penjualan</code> ·
                <code>priceBands: band, penjualan</code> ·
                <code>bulananPromo: bulan(YYYY-MM), promo, nonpromo</code>
            </div>
        </div>
    </section>

    <main class="container">
        <!-- LATAR BELAKANG -->
        <section id="latar" class="section">
            <h2><span class="bar"></span>Latar Belakang</h2>
            <div class="card">
                <p>
                    Analisis ini memetakan pola penjualan buku di Gramedia Purwakarta sebagai dasar pengambilan
                    keputusan stok, promosi, dan tata rak. Kolaborasi dengan UPI Purwakarta menempatkan hasil
                    analitik sebagai jembatan antara kebutuhan akademik–kemahasiswaan dan strategi ritel toko.
                </p>
                <p>
                    <b>Keterkaitan dengan peluang kerja sama UPI Purwakarta:</b> temuan kategori unggul, tren musiman,
                    bestseller, price band favorit, hingga dampak promosi dapat langsung diterjemahkan menjadi program
                    bersama <i>Prodi</i> (mis. PSTI), <i>Himpunan/BEM/UKM</i>, <i>Perpustakaan UPI</i>, dan unit
                    pendukung (kemitraan,
                    karier, riset). Contohnya: kurasi “Pojok Bacaan Prodi”, kuliah tamu penulis & bedah buku, paket
                    bundling harga ramah mahasiswa, keanggotaan/loyalty kampus, serta proyek magang/riset analitik.
                </p>
                <div class="tags" aria-label="contoh peluang">
                    <span class="tag">Pojok Bacaan Prodi</span>
                    <span class="tag">Kuliah Tamu Penulis</span>
                    <span class="tag">Bundling Mahasiswa</span>
                    <span class="tag">Membership Kampus</span>
                    <span class="tag">Magang/Riset Data</span>
                    <span class="tag">Dashboard Bersama</span>
                </div>
            </div>
        </section>

        <!-- PB UMUM -->
        <section id="pb" class="section">
            <h2><span class="bar"></span>Pertanyaan Bisnis & Visualisasi</h2>
            <div class="grid">
                <!-- PB#1 -->
                <article class="card q-card" id="pb1">
                    <header>
                        <div>
                            <h3 class="q-title">PB#1 – Kategori apa yang menyumbang penjualan terbesar?</h3>
                            <p class="q-desc">Komposisi pendapatan per kategori untuk prioritas stok & promosi.</p>
                            <div class="q-meta"><span class="pill">Bar</span><span class="pill">Total per
                                    kategori</span></div>
                        </div>
                    </header>
                    <div class="chart-box"><canvas id="chartKategori" aria-label="Bar kategori penjualan"></canvas>
                    </div>
                    <div class="insight">
                        <div class="muted">Kesimpulan singkat:</div>
                        <div id="insKategori"><em>Menunggu data…</em></div>
                    </div>
                </article>

                <!-- PB#2 -->
                <article class="card q-card" id="pb2">
                    <header>
                        <div>
                            <h3 class="q-title">PB#2 – Bagaimana tren penjualan bulanan sepanjang tahun?</h3>
                            <p class="q-desc">Deteksi pola musiman & momentum promosi.</p>
                            <div class="q-meta"><span class="pill">Line (area)</span><span class="pill">Per bulan</span>
                            </div>
                        </div>
                    </header>
                    <div class="chart-box"><canvas id="chartBulanan" aria-label="Line tren bulanan"></canvas></div>
                    <div class="insight">
                        <div class="muted">Kesimpulan singkat:</div>
                        <div id="insBulanan"><em>Menunggu data…</em></div>
                    </div>
                </article>

                <!-- PB#3 -->
                <article class="card q-card" id="pb3">
                    <header>
                        <div>
                            <h3 class="q-title">PB#3 – Judul/penulis mana yang menjadi kontributor terbesar?</h3>
                            <p class="q-desc">Bestseller untuk penataan display & kerja sama penerbit.</p>
                            <div class="q-meta"><span class="pill">Horizontal Bar</span><span class="pill">Top N</span>
                            </div>
                        </div>
                    </header>
                    <div class="chart-box"><canvas id="chartTop" aria-label="Horizontal bar top judul/penulis"></canvas>
                    </div>
                    <div class="insight">
                        <div class="muted">Kesimpulan singkat:</div>
                        <div id="insTop"><em>Menunggu data…</em></div>
                    </div>
                </article>

                <!-- PB#4 -->
                <article class="card q-card" id="pb4">
                    <header>
                        <div>
                            <h3 class="q-title">PB#4 – Penerbit mana yang berkontribusi terbesar?</h3>
                            <p class="q-desc">Memahami pemasok strategis untuk kolaborasi & alokasi rak.</p>
                            <div class="q-meta"><span class="pill">Donut</span><span class="pill">Total per
                                    penerbit</span></div>
                        </div>
                    </header>
                    <div class="chart-box"><canvas id="chartPenerbit" aria-label="Donut kontribusi penerbit"></canvas>
                    </div>
                    <div class="insight">
                        <div class="muted">Kesimpulan singkat:</div>
                        <div id="insPenerbit"><em>Menunggu data…</em></div>
                    </div>
                </article>

                <!-- PB#5 -->
                <article class="card q-card" id="pb5">
                    <header>
                        <div>
                            <h3 class="q-title">PB#5 – Pola penjualan per hari (Sen–Min)?</h3>
                            <p class="q-desc">Untuk jadwal staf & aktivitas promosi mingguan.</p>
                            <div class="q-meta"><span class="pill">Bar</span><span class="pill">Agregat per hari</span>
                            </div>
                        </div>
                    </header>
                    <div class="chart-box"><canvas id="chartWeekday" aria-label="Bar penjualan per hari"></canvas></div>
                    <div class="insight">
                        <div class="muted">Kesimpulan singkat:</div>
                        <div id="insWeekday"><em>Menunggu data…</em></div>
                    </div>
                </article>

                <!-- PB#6 -->
                <article class="card q-card" id="pb6">
                    <header>
                        <div>
                            <h3 class="q-title">PB#6 – Rentang harga mana yang paling laku?</h3>
                            <p class="q-desc">Preferensi daya beli untuk strategi bundling & diskon.</p>
                            <div class="q-meta"><span class="pill">Bar</span><span class="pill">Distribusi price
                                    band</span></div>
                        </div>
                    </header>
                    <div class="chart-box"><canvas id="chartPriceBand" aria-label="Bar distribusi price band"></canvas>
                    </div>
                    <div class="insight">
                        <div class="muted">Kesimpulan singkat:</div>
                        <div id="insPriceBand"><em>Menunggu data…</em></div>
                    </div>
                </article>

                <!-- PB#7 -->
                <article class="card q-card" id="pb7">
                    <header>
                        <div>
                            <h3 class="q-title">PB#7 – Seberapa besar dampak promosi?</h3>
                            <p class="q-desc">Perbandingan penjualan bulanan: promo vs non-promo.</p>
                            <div class="q-meta"><span class="pill">Grouped Bar</span><span class="pill">Promo vs
                                    Non-promo</span></div>
                        </div>
                    </header>
                    <div class="chart-box"><canvas id="chartPromo"
                            aria-label="Bar promo vs non-promo per bulan"></canvas></div>
                    <div class="insight">
                        <div class="muted">Kesimpulan singkat:</div>
                        <div id="insPromo"><em>Menunggu data…</em></div>
                    </div>
                </article>
            </div>
        </section>

        <!-- PB UPI: KHUSUS UPI PURWAKARTA -->
        <section id="pb-upi" class="section">
            <h2><span class="bar"></span>Pertanyaan Bisnis UPI Purwakarta</h2>
            <div class="grid">
                <!-- UPI-Q1 -->
                <article class="card q-card" id="upi-q1">
                    <header>
                        <div>
                            <h3 class="q-title">UPI-Q1 – Kapan waktu terbaik aktivasi kampus?</h3>
                            <p class="q-desc">Share promo per bulan (%) untuk sinkronisasi agenda kampus.</p>
                            <div class="q-meta"><span class="pill">Line</span><span class="pill">Promo/Total (%)</span>
                            </div>
                        </div>
                    </header>
                    <div class="chart-box"><canvas id="chartUPIPromoShare" aria-label="Share promo per bulan"></canvas>
                    </div>
                    <div class="insight">
                        <div class="muted">Kesimpulan singkat:</div>
                        <div id="insUPIPromo"><em>Menunggu data…</em></div>
                    </div>
                </article>

                <!-- UPI-Q2 -->
                <article class="card q-card" id="upi-q2">
                    <header>
                        <div>
                            <h3 class="q-title">UPI-Q2 – Seberapa besar proporsi harga ramah mahasiswa?</h3>
                            <p class="q-desc">Perbandingan penjualan price band ≤100rb vs lainnya.</p>
                            <div class="q-meta"><span class="pill">Donut</span><span class="pill">≤100rb vs
                                    >100rb</span></div>
                        </div>
                    </header>
                    <div class="chart-box"><canvas id="chartUPIAfford" aria-label="Affordability price band"></canvas>
                    </div>
                    <div class="insight">
                        <div class="muted">Kesimpulan singkat:</div>
                        <div id="insUPIAfford"><em>Menunggu data…</em></div>
                    </div>
                </article>

                <!-- UPI-Q3 -->
                <article class="card q-card" id="upi-q3">
                    <header>
                        <div>
                            <h3 class="q-title">UPI-Q3 – Judul apa yang paling cocok untuk event kampus?</h3>
                            <p class="q-desc">Top 5 judul sebagai kandidat bedah buku / meet-the-author.</p>
                            <div class="q-meta"><span class="pill">Horizontal Bar</span><span class="pill">Top 5</span>
                            </div>
                        </div>
                    </header>
                    <div class="chart-box"><canvas id="chartUPITopTitles" aria-label="Top 5 judul kampus"></canvas>
                    </div>
                    <div class="insight">
                        <div class="muted">Kesimpulan singkat:</div>
                        <div id="insUPITop"><em>Menunggu data…</em></div>
                    </div>
                </article>

                <!-- UPI-Q4 -->
                <article class="card q-card" id="upi-q4">
                    <header>
                        <div>
                            <h3 class="q-title">UPI-Q4 – Penerbit mana yang paling prioritas untuk kemitraan?</h3>
                            <p class="q-desc">Top 5 penerbit untuk program kolaborasi kampus.</p>
                            <div class="q-meta"><span class="pill">Horizontal Bar</span><span class="pill">Top 5</span>
                            </div>
                        </div>
                    </header>
                    <div class="chart-box"><canvas id="chartUPIPublishers" aria-label="Top penerbit kemitraan"></canvas>
                    </div>
                    <div class="insight">
                        <div class="muted">Kesimpulan singkat:</div>
                        <div id="insUPIPub"><em>Menunggu data…</em></div>
                    </div>
                </article>
            </div>
        </section>

        <!-- KESIMPULAN OTOMATIS -->
        <section id="kesimpulan" class="section">
            <h2><span class="bar"></span>Kesimpulan Otomatis</h2>
            <div class="card" id="kesimpulanAkhir">
                <p class="muted">Ringkasan otomatis dari seluruh visualisasi (berbasis data terkini).</p>
                <div id="insRingkas"><em>Ringkasan akan terisi berdasarkan data.</em></div>
            </div>
        </section>

        <!-- UPI: KESIMPULAN FINAL + TABEL REKOMENDASI -->
        <section id="upi" class="section">
            <h2><span class="bar"></span>Kesimpulan UPI Purwakarta (Final)</h2>
            <div class="card">
                <p id="upiConclusion" class="muted"><em>Menunggu ringkasan berbasis data…</em></p>
                <div class="table-wrap">
                    <table class="tbl">
                        <thead>
                            <tr>
                                <th style="width:18%">Fokus Kerja Sama</th>
                                <th style="width:16%">Mitra</th>
                                <th style="width:24%">Dasar Data</th>
                                <th style="width:22%">Bentuk Program</th>
                                <th style="width:10%">KPI Awal</th>
                                <th style="width:10%">Waktu</th>
                            </tr>
                        </thead>
                        <tbody id="upiTbody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <footer><small>© 2025 – Kolaborasi UPI Purwakarta · by Rafli A.</small></footer>
    </main>

    <script>
        /* ============================================================
           DATA: contoh default (bisa ditimpa hasil upload CSV/JSON)
        ============================================================ */
        let DATA = {
            kategori: [
                { nama: "Fiksi", penjualan: 1420 },
                { nama: "Nonfiksi", penjualan: 1230 },
                { nama: "Anak", penjualan: 980 },
                { nama: "Komik", penjualan: 860 },
                { nama: "Bisnis", penjualan: 760 },
                { nama: "Agama", penjualan: 640 }
            ],
            bulanan: [
                { bulan: "2025-01", penjualan: 9200 },
                { bulan: "2025-02", penjualan: 9800 },
                { bulan: "2025-03", penjualan: 10100 },
                { bulan: "2025-04", penjualan: 9600 },
                { bulan: "2025-05", penjualan: 11050 },
                { bulan: "2025-06", penjualan: 12300 },
                { bulan: "2025-07", penjualan: 11800 }
            ],
            topItem: [
                { label: "Judul A", penjualan: 820 },
                { label: "Judul B", penjualan: 760 },
                { label: "Judul C", penjualan: 690 },
                { label: "Judul D", penjualan: 570 },
                { label: "Judul E", penjualan: 560 },
                { label: "Judul F", penjualan: 550 }
            ],
            topN: 10,
            penerbit: [
                { nama: "Gramedia Pustaka Utama", penjualan: 5400 },
                { nama: "Mizan", penjualan: 3100 },
                { nama: "Elex Media", penjualan: 2700 },
                { nama: "Bentang", penjualan: 1800 },
                { nama: "Andi", penjualan: 1200 }
            ],
            weekday: [
                { hari: "Sen", penjualan: 1500 },
                { hari: "Sel", penjualan: 1600 },
                { hari: "Rab", penjualan: 1700 },
                { hari: "Kam", penjualan: 1800 },
                { hari: "Jum", penjualan: 2100 },
                { hari: "Sab", penjualan: 2600 },
                { hari: "Min", penjualan: 2300 }
            ],
            priceBands: [
                { band: "<50rb", penjualan: 2200 },
                { band: "50–99rb", penjualan: 4100 },
                { band: "100–149rb", penjualan: 1800 },
                { band: "150–199rb", penjualan: 900 },
                { band: "≥200rb", penjualan: 350 }
            ],
            bulananPromo: [
                { bulan: "2025-01", promo: 1800, nonpromo: 7400 },
                { bulan: "2025-02", promo: 2100, nonpromo: 7700 },
                { bulan: "2025-03", promo: 2300, nonpromo: 7800 },
                { bulan: "2025-04", promo: 2000, nonpromo: 7600 },
                { bulan: "2025-05", promo: 2800, nonpromo: 8250 },
                { bulan: "2025-06", promo: 3600, nonpromo: 8700 },
                { bulan: "2025-07", promo: 3200, nonpromo: 8600 }
            ]
        };

        /* ======================= Util & Helpers ======================= */
        const fmtIDR = (v) => new Intl.NumberFormat('id-ID', { maximumFractionDigits: 0 }).format(v);
        const bulanID = (ym) => { const [y, m] = ym.split("-").map(Number); const d = new Date(y, m - 1, 1); return d.toLocaleDateString('id-ID', { month: 'short', year: 'numeric' }); };
        const makeAlpha = (hex, alpha = 0.2) => { const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); if (!m) return `rgba(90,162,255,${alpha})`; const r = parseInt(m[1], 16), g = parseInt(m[2], 16), b = parseInt(m[3], 16); return `rgba(${r},${g},${b},${alpha})`; };
        const brandHex = getComputedStyle(document.documentElement).getPropertyValue('--brand').trim() || '#5aa2ff';
        const accentHex = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#41d3bd';
        const sum = (arr, key) => arr.reduce((s, d) => s + (key ? d[key] : d), 0);
        const pct = (a, b) => b ? (a / b * 100) : 0;

        /* ===================== CSV/JSON Upload Logic ===================== */
        const fileInput = document.getElementById('fileInput');
        const btnUseSample = document.getElementById('btnUseSample');
        const uploadStatus = document.getElementById('uploadStatus');

        const datasetNameMap = (name) => {
            const key = (name || '').toLowerCase().replace(/\.(csv|json)$/, '').replace(/[^a-z]/g, '');
            const map = {
                kategori: 'kategori', category: 'kategori', categories: 'kategori',
                bulanan: 'bulanan', monthly: 'bulanan',
                topitem: 'topItem', top: 'topItem',
                penerbit: 'penerbit', publisher: 'penerbit', publishers: 'penerbit',
                weekday: 'weekday', harian: 'weekday', hari: 'weekday',
                pricebands: 'priceBands', priceband: 'priceBands', band: 'priceBands',
                bulananpromo: 'bulananPromo', promobulanan: 'bulananPromo', promo: 'bulananPromo'
            };
            return map[key] || null;
        };

        function splitCSVRow(row) {
            // Split CSV row by commas while respecting quotes
            const out = [];
            let cur = '', inQ = false;
            for (let i = 0; i < row.length; i++) {
                const ch = row[i];
                if (ch === '"') {
                    if (inQ && row[i + 1] === '"') { cur += '"'; i++; } // escaped quote
                    else inQ = !inQ;
                } else if (ch === ',' && !inQ) {
                    out.push(cur.trim()); cur = '';
                } else {
                    cur += ch;
                }
            }
            out.push(cur.trim());
            return out;
        }

        function parseCSV(text) {
            const lines = text.replace(/\r/g, '').split('\n').filter(l => l.trim().length > 0);
            if (!lines.length) return [];
            const header = splitCSVRow(lines[0]).map(h => h.trim());
            const rows = [];
            for (let i = 1; i < lines.length; i++) {
                const cols = splitCSVRow(lines[i]);
                const obj = {};
                header.forEach((h, idx) => { obj[h] = (cols[idx] ?? '').trim(); });
                rows.push(obj);
            }
            return rows;
        }

        function coerceNumbers(arr, numericKeys) {
            arr.forEach(o => {
                (numericKeys || []).forEach(k => {
                    if (o[k] !== undefined && o[k] !== null && o[k] !== '') {
                        const num = Number(o[k]);
                        o[k] = isNaN(num) ? 0 : num;
                    }
                });
            });
            return arr;
        }

        function setDATAFromCSV(name, rows) {
            const ds = datasetNameMap(name);
            if (!ds) { return { ok: false, msg: `Nama berkas tidak dikenali: ${name}` }; }

            // Map headers -> expected shapes
            const lowHeaders = rows.length ? Object.keys(rows[0]).map(h => h.toLowerCase()) : [];
            const normRows = rows.map(r => {
                const o = {};
                Object.keys(r).forEach(k => o[k.toLowerCase()] = r[k]);
                return o;
            });

            if (ds === 'kategori') { // nama, penjualan
                DATA.kategori = coerceNumbers(normRows.map(r => ({ nama: r.nama, penjualan: r.penjualan })), ['penjualan']);
                return { ok: true, msg: `Memuat ${rows.length} baris ke DATA.kategori` };
            }
            if (ds === 'bulanan') { // bulan, penjualan
                DATA.bulanan = coerceNumbers(normRows.map(r => ({ bulan: r.bulan, penjualan: r.penjualan })), ['penjualan']);
                return { ok: true, msg: `Memuat ${rows.length} baris ke DATA.bulanan` };
            }
            if (ds === 'topItem') { // label, penjualan
                DATA.topItem = coerceNumbers(normRows.map(r => ({ label: r.label, penjualan: r.penjualan })), ['penjualan']);
                return { ok: true, msg: `Memuat ${rows.length} baris ke DATA.topItem` };
            }
            if (ds === 'penerbit') { // nama, penjualan
                DATA.penerbit = coerceNumbers(normRows.map(r => ({ nama: r.nama, penjualan: r.penjualan })), ['penjualan']);
                return { ok: true, msg: `Memuat ${rows.length} baris ke DATA.penerbit` };
            }
            if (ds === 'weekday') { // hari, penjualan
                DATA.weekday = coerceNumbers(normRows.map(r => ({ hari: r.hari, penjualan: r.penjualan })), ['penjualan']);
                return { ok: true, msg: `Memuat ${rows.length} baris ke DATA.weekday` };
            }
            if (ds === 'priceBands') { // band, penjualan
                DATA.priceBands = coerceNumbers(normRows.map(r => ({ band: r.band, penjualan: r.penjualan })), ['penjualan']);
                return { ok: true, msg: `Memuat ${rows.length} baris ke DATA.priceBands` };
            }
            if (ds === 'bulananPromo') { // bulan, promo, nonpromo
                DATA.bulananPromo = coerceNumbers(normRows.map(r => ({ bulan: r.bulan, promo: r.promo, nonpromo: r.nonpromo })), ['promo', 'nonpromo']);
                return { ok: true, msg: `Memuat ${rows.length} baris ke DATA.bulananPromo` };
            }
            return { ok: false, msg: `Dataset tidak didukung: ${ds}` };
        }

        function mergeDATAFromJSON(obj) {
            // Terima objek full (punya banyak key) atau array satu dataset
            if (Array.isArray(obj)) {
                // coba deteksi bentuk array
                if (obj[0] && 'nama' in obj[0] && 'penjualan' in obj[0]) DATA.kategori = coerceNumbers(obj, ['penjualan']);
                else if (obj[0] && 'bulan' in obj[0] && 'penjualan' in obj[0]) DATA.bulanan = coerceNumbers(obj, ['penjualan']);
                else if (obj[0] && 'label' in obj[0] && 'penjualan' in obj[0]) DATA.topItem = coerceNumbers(obj, ['penjualan']);
                else if (obj[0] && 'bulan' in obj[0] && ('promo' in obj[0] || 'nonpromo' in obj[0])) DATA.bulananPromo = coerceNumbers(obj, ['promo', 'nonpromo']);
                else if (obj[0] && 'band' in obj[0] && 'penjualan' in obj[0]) DATA.priceBands = coerceNumbers(obj, ['penjualan']);
                else if (obj[0] && 'hari' in obj[0] && 'penjualan' in obj[0]) DATA.weekday = coerceNumbers(obj, ['penjualan']);
            } else {
                const keys = ['kategori', 'bulanan', 'topItem', 'penerbit', 'weekday', 'priceBands', 'bulananPromo', 'topN'];
                keys.forEach(k => {
                    if (obj[k] !== undefined) {
                        if (Array.isArray(obj[k])) {
                            if (k === 'bulananPromo') coerceNumbers(obj[k], ['promo', 'nonpromo']);
                            else if (k === 'kategori' || k === 'penerbit' || k === 'topItem' || k === 'weekday' || k === 'priceBands' || k === 'bulanan') coerceNumbers(obj[k], ['penjualan']);
                        }
                        DATA[k] = obj[k];
                    }
                });
            }
        }

        fileInput.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files || []);
            if (!files.length) return;
            let msgs = [];
            for (const f of files) {
                const text = await f.text();
                if (f.name.toLowerCase().endsWith('.json')) {
                    try {
                        const obj = JSON.parse(text);
                        mergeDATAFromJSON(obj);
                        msgs.push(`<span class="ok">JSON</span> <code>${f.name}</code> dimuat`);
                    } catch (err) {
                        msgs.push(`<span class="warn">Gagal JSON</span> <code>${f.name}</code>: ${err.message}`);
                    }
                } else if (f.name.toLowerCase().endsWith('.csv')) {
                    const rows = parseCSV(text);
                    const res = setDATAFromCSV(f.name, rows);
                    msgs.push(`${res.ok ? '<span class="ok">CSV</span>' : '<span class="warn">CSV</span>'} <code>${f.name}</code> → ${res.msg}`);
                } else {
                    msgs.push(`<span class="warn">Lewati</span> <code>${f.name}</code> (hanya .csv/.json)`);
                }
            }
            uploadStatus.innerHTML = msgs.join(' · ');
            renderAll();
        });

        btnUseSample.addEventListener('click', () => {
            uploadStatus.innerHTML = '<span class="ok">Menggunakan data contoh.</span>';
            DATA = JSON.parse(JSON.stringify(DATA)); // no-op; sekadar trigger
            renderAll();
        });

        /* ========================== Charts =========================== */
        let chartKategori, chartBulanan, chartTop, chartPenerbit, chartWeekday, chartPriceBand, chartPromo;
        let chartUPIPromoShare, chartUPIAfford, chartUPITopTitles, chartUPIPublishers;

        function renderKategori() {
            const labels = (DATA.kategori || []).map(d => d.nama);
            const values = (DATA.kategori || []).map(d => +d.penjualan || 0);
            if (!chartKategori) {
                const ctx = document.getElementById('chartKategori').getContext('2d');
                chartKategori = new Chart(ctx, {
                    type: 'bar',
                    data: { labels, datasets: [{ label: 'Penjualan', data: values, backgroundColor: makeAlpha(brandHex, .35), borderColor: brandHex, borderWidth: 1.5 }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, ticks: { callback: v => fmtIDR(v) } } }, plugins: { legend: { display: false } } }
                });
            } else {
                chartKategori.data.labels = labels; chartKategori.data.datasets[0].data = values; chartKategori.update();
            }
            document.getElementById('insKategori').innerHTML = insightKategori(DATA.kategori);
        }

        function renderBulanan() {
            const labels = (DATA.bulanan || []).map(d => bulanID(d.bulan));
            const values = (DATA.bulanan || []).map(d => +d.penjualan || 0);
            if (!chartBulanan) {
                const ctx = document.getElementById('chartBulanan').getContext('2d');
                const grad = ctx.createLinearGradient(0, 0, 0, 320); grad.addColorStop(0, makeAlpha(accentHex, .35)); grad.addColorStop(1, makeAlpha(accentHex, .02));
                chartBulanan = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets: [{ label: 'Penjualan Bulanan', data: values, fill: true, backgroundColor: grad, borderColor: accentHex, borderWidth: 2, tension: .28, pointRadius: 3, pointHoverRadius: 5 }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { beginAtZero: false, ticks: { callback: v => fmtIDR(v) } } }, plugins: { legend: { display: false } } }
                });
            } else {
                chartBulanan.data.labels = labels; chartBulanan.data.datasets[0].data = values; chartBulanan.update();
            }
            document.getElementById('insBulanan').innerHTML = insightBulanan(DATA.bulanan);
        }

        function renderTop() {
            const sortedTop = [...(DATA.topItem || [])].sort((a, b) => b.penjualan - a.penjualan).slice(0, DATA.topN || 10);
            const labels = sortedTop.map(d => d.label);
            const values = sortedTop.map(d => +d.penjualan || 0);
            if (!chartTop) {
                const ctx = document.getElementById('chartTop').getContext('2d');
                chartTop = new Chart(ctx, {
                    type: 'bar',
                    data: { labels, datasets: [{ label: 'Penjualan', data: values, backgroundColor: makeAlpha(brandHex, .28), borderColor: brandHex, borderWidth: 1.2 }] },
                    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { callback: v => fmtIDR(v) } }, y: { grid: { display: false } } }, plugins: { legend: { display: false } } }
                });
            } else {
                chartTop.data.labels = labels; chartTop.data.datasets[0].data = values; chartTop.update();
            }
            document.getElementById('insTop').innerHTML = insightTop(DATA.topItem, 3);
        }

        function renderPenerbit() {
            const labels = (DATA.penerbit || []).map(d => d.nama);
            const values = (DATA.penerbit || []).map(d => +d.penjualan || 0);
            const colors = labels.map((_, i) => i % 2 === 0 ? makeAlpha(brandHex, .45) : makeAlpha(accentHex, .45));
            const borders = labels.map((_, i) => i % 2 === 0 ? brandHex : accentHex);
            if (!chartPenerbit) {
                const ctx = document.getElementById('chartPenerbit').getContext('2d');
                chartPenerbit = new Chart(ctx, {
                    type: 'doughnut',
                    data: { labels, datasets: [{ data: values, backgroundColor: colors, borderColor: borders, borderWidth: 1.2, hoverOffset: 4 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
            } else {
                chartPenerbit.data.labels = labels; chartPenerbit.data.datasets[0].data = values; chartPenerbit.update();
            }
            document.getElementById('insPenerbit').innerHTML = insightPenerbit(DATA.penerbit);
        }

        function renderWeekday() {
            const orderWeek = ["Sen", "Sel", "Rab", "Kam", "Jum", "Sab", "Min"];
            const wd = [...(DATA.weekday || [])].sort((a, b) => orderWeek.indexOf(a.hari) - orderWeek.indexOf(b.hari));
            const labels = wd.map(d => d.hari);
            const values = wd.map(d => +d.penjualan || 0);
            if (!chartWeekday) {
                const ctx = document.getElementById('chartWeekday').getContext('2d');
                chartWeekday = new Chart(ctx, {
                    type: 'bar',
                    data: { labels, datasets: [{ label: 'Penjualan', data: values, backgroundColor: makeAlpha(brandHex, .35), borderColor: brandHex, borderWidth: 1.5 }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, ticks: { callback: v => fmtIDR(v) } } }, plugins: { legend: { display: false } } }
                });
            } else {
                chartWeekday.data.labels = labels; chartWeekday.data.datasets[0].data = values; chartWeekday.update();
            }
            document.getElementById('insWeekday').innerHTML = insightWeekday(DATA.weekday);
        }

        function renderPriceBand() {
            const labels = (DATA.priceBands || []).map(d => d.band);
            const values = (DATA.priceBands || []).map(d => +d.penjualan || 0);
            if (!chartPriceBand) {
                const ctx = document.getElementById('chartPriceBand').getContext('2d');
                chartPriceBand = new Chart(ctx, {
                    type: 'bar',
                    data: { labels, datasets: [{ label: 'Penjualan', data: values, backgroundColor: makeAlpha(accentHex, .35), borderColor: accentHex, borderWidth: 1.5 }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, ticks: { callback: v => fmtIDR(v) } } }, plugins: { legend: { display: false } } }
                });
            } else {
                chartPriceBand.data.labels = labels; chartPriceBand.data.datasets[0].data = values; chartPriceBand.update();
            }
            document.getElementById('insPriceBand').innerHTML = insightPriceBand(DATA.priceBands);
        }

        function renderPromo() {
            const labels = (DATA.bulananPromo || []).map(d => bulanID(d.bulan));
            const promo = (DATA.bulananPromo || []).map(d => +d.promo || 0);
            const non = (DATA.bulananPromo || []).map(d => +d.nonpromo || 0);
            if (!chartPromo) {
                const ctx = document.getElementById('chartPromo').getContext('2d');
                chartPromo = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels, datasets: [
                            { label: 'Promo', data: promo, backgroundColor: makeAlpha(brandHex, .4), borderColor: brandHex, borderWidth: 1.2 },
                            { label: 'Non-promo', data: non, backgroundColor: makeAlpha(accentHex, .35), borderColor: accentHex, borderWidth: 1.2 }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: false }, y: { beginAtZero: true, ticks: { callback: v => fmtIDR(v) } } }, plugins: { legend: { position: 'bottom' } } }
                });
            } else {
                chartPromo.data.labels = labels;
                chartPromo.data.datasets[0].data = promo;
                chartPromo.data.datasets[1].data = non;
                chartPromo.update();
            }
            document.getElementById('insPromo').innerHTML = insightPromo(DATA.bulananPromo);
        }

        // ====== PB UPI render ======
        const AFFORD_MAX = 100_000;
        function parseBandRange(label) {
            const clean = (label || '').toLowerCase().replace(/\s/g, '');
            const num = s => Number(s.replace(/[^\d]/g, '')) * 1000; // "50rb" -> 50000
            if (/^</.test(clean)) { const n = num(clean); return { min: 0, max: n }; }
            if (/^≤/.test(clean) || /^<=/.test(clean)) { const n = num(clean); return { min: 0, max: n }; }
            if (/^≥/.test(clean) || /^>=/.test(clean)) { const n = num(clean); return { min: n, max: Infinity }; }
            const m = clean.match(/(\d+)\D+(\d+)/); if (m) return { min: Number(m[1]) * 1000, max: Number(m[2]) * 1000 };
            const n = num(clean); return { min: 0, max: n };
        }

        function renderUPIPromoShare() {
            const labels = (DATA.bulananPromo || []).map(d => bulanID(d.bulan));
            const share = (DATA.bulananPromo || []).map(d => {
                const t = (+d.promo || 0) + (+d.nonpromo || 0); return t ? +((+d.promo) / t * 100).toFixed(1) : 0;
            });
            if (!chartUPIPromoShare) {
                const ctx = document.getElementById('chartUPIPromoShare').getContext('2d');
                chartUPIPromoShare = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets: [{ label: 'Share Promo (%)', data: share, fill: true, backgroundColor: makeAlpha(brandHex, .25), borderColor: brandHex, borderWidth: 2, tension: .28, pointRadius: 3, pointHoverRadius: 5 }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100, ticks: { callback: v => `${v}%` } }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } }
                });
            } else {
                chartUPIPromoShare.data.labels = labels; chartUPIPromoShare.data.datasets[0].data = share; chartUPIPromoShare.update();
            }
            if (share.length) {
                const idx = share.reduce((mi, v, i) => v > (share[mi] ?? -1) ? i : mi, 0);
                document.getElementById('insUPIPromo').innerHTML = `Bulan terbaik aktivasi: <b>${labels[idx]}</b> (share promo ${share[idx]}%).`;
            } else {
                document.getElementById('insUPIPromo').textContent = 'Data promo kosong.';
            }
        }

        function renderUPIAfford() {
            let affordable = 0, nonaff = 0;
            (DATA.priceBands || []).forEach(b => {
                const r = parseBandRange(b.band || '');
                const mid = (r.max === Infinity) ? r.min * 1.25 : (r.min + r.max) / 2;
                if (mid <= AFFORD_MAX) affordable += (+b.penjualan || 0); else nonaff += (+b.penjualan || 0);
            });
            const ctx = document.getElementById('chartUPIAfford').getContext('2d');
            const data = [affordable, nonaff];
            if (!chartUPIAfford) {
                chartUPIAfford = new Chart(ctx, {
                    type: 'doughnut',
                    data: { labels: ['≤100rb', '>100rb'], datasets: [{ data, backgroundColor: [makeAlpha(accentHex, .45), makeAlpha(brandHex, .45)], borderColor: [accentHex, brandHex], borderWidth: 1.2, hoverOffset: 4 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
            } else {
                chartUPIAfford.data.datasets[0].data = data; chartUPIAfford.update();
            }
            const total = affordable + nonaff;
            document.getElementById('insUPIAfford').innerHTML = total ? `Proporsi <b>≤100rb</b> ~<b>${(affordable / total * 100).toFixed(1)}%</b> (≈${fmtIDR(affordable)} unit).` : 'Data price band kosong.';
        }

        function renderUPITopTitles() {
            const top5 = [...(DATA.topItem || [])].sort((a, b) => b.penjualan - a.penjualan).slice(0, 5);
            const labels = top5.map(d => d.label);
            const values = top5.map(d => +d.penjualan || 0);
            const ctx = document.getElementById('chartUPITopTitles').getContext('2d');
            if (!chartUPITopTitles) {
                chartUPITopTitles = new Chart(ctx, {
                    type: 'bar',
                    data: { labels, datasets: [{ label: 'Penjualan', data: values, backgroundColor: makeAlpha(brandHex, .35), borderColor: brandHex, borderWidth: 1.2 }] },
                    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { callback: v => fmtIDR(v) } }, y: { grid: { display: false } } }, plugins: { legend: { display: false } } }
                });
            } else {
                chartUPITopTitles.data.labels = labels; chartUPITopTitles.data.datasets[0].data = values; chartUPITopTitles.update();
            }
            document.getElementById('insUPITop').innerHTML = top5.length ? `Kandidat event: ${labels.map((s, i) => `${i + 1}) <b>${s}</b>`).join('; ')}.` : 'Data judul kosong.';
        }

        function renderUPIPublishers() {
            const top = [...(DATA.penerbit || [])].sort((a, b) => b.penjualan - a.penjualan).slice(0, 5);
            const labels = top.map(d => d.nama);
            const values = top.map(d => +d.penjualan || 0);
            const ctx = document.getElementById('chartUPIPublishers').getContext('2d');
            if (!chartUPIPublishers) {
                chartUPIPublishers = new Chart(ctx, {
                    type: 'bar',
                    data: { labels, datasets: [{ label: 'Penjualan', data: values, backgroundColor: makeAlpha(accentHex, .35), borderColor: accentHex, borderWidth: 1.2 }] },
                    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { callback: v => fmtIDR(v) } }, y: { grid: { display: false } } }, plugins: { legend: { display: false } } }
                });
            } else {
                chartUPIPublishers.data.labels = labels; chartUPIPublishers.data.datasets[0].data = values; chartUPIPublishers.update();
            }
            document.getElementById('insUPIPub').innerHTML = top.length ? `Prioritas kemitraan: ${labels.map((s, i) => `${i + 1}) <b>${s}</b>`).join('; ')}.` : 'Data penerbit kosong.';
        }

        /* ===================== Insights Otomatis ===================== */
        function insightKategori(arr) {
            if (!arr?.length) return "Data kategori kosong.";
            const total = sum(arr, 'penjualan');
            const top = arr.reduce((a, b) => a.penjualan > b.penjualan ? a : b);
            const share = pct(top.penjualan, total);
            return `<b>${top.nama}</b> memimpin dengan ${fmtIDR(top.penjualan)} unit (~${share.toFixed(1)}% kontribusi).`;
        }
        function insightBulanan(arr) {
            if (!arr?.length) return "Data bulanan kosong.";
            const first = arr[0].penjualan, last = arr[arr.length - 1].penjualan;
            const delta = last - first, pctDelta = first ? (delta / first * 100) : 0;
            const peak = arr.reduce((a, b) => a.penjualan > b.penjualan ? a : b);
            return `Tren ${delta >= 0 ? '<b>naik</b>' : '<b>turun</b>'} (${delta >= 0 ? '+' : ''}${fmtIDR(delta)}; ${pctDelta >= 0 ? '+' : ''}${pctDelta.toFixed(1)}%). Puncak di <b>${bulanID(peak.bulan)}</b> (${fmtIDR(peak.penjualan)} unit).`;
        }
        function insightTop(arr, N = 3) {
            if (!arr?.length) return "Data top item kosong.";
            const top = [...arr].sort((a, b) => b.penjualan - a.penjualan).slice(0, N);
            const list = top.map((d, i) => `${i + 1}) <b>${d.label}</b> (${fmtIDR(d.penjualan)})`).join('; ');
            return `Bestseller: ${list}.`;
        }
        function insightPenerbit(arr) {
            if (!arr?.length) return "Data penerbit kosong.";
            const total = sum(arr, 'penjualan');
            const top = arr.reduce((a, b) => a.penjualan > b.penjualan ? a : b);
            return `<b>${top.nama}</b> paling dominan (${fmtIDR(top.penjualan)} unit; ~${pct(top.penjualan, total).toFixed(1)}%).`;
        }
        function insightWeekday(arr) {
            if (!arr?.length) return "Data weekday kosong.";
            const best = arr.reduce((a, b) => a.penjualan > b.penjualan ? a : b);
            const worst = arr.reduce((a, b) => a.penjualan < b.penjualan ? a : b);
            return `Hari tersibuk: <b>${best.hari}</b> (${fmtIDR(best.penjualan)}). Tersantai: <b>${worst.hari}</b> (${fmtIDR(worst.penjualan)}).`;
        }
        function insightPriceBand(arr) {
            if (!arr?.length) return "Data price band kosong.";
            const top = arr.reduce((a, b) => a.penjualan > b.penjualan ? a : b);
            return `Rentang paling laku: <b>${top.band}</b> (${fmtIDR(top.penjualan)} unit).`;
        }
        function insightPromo(arr) {
            if (!arr?.length) return "Data promo kosong.";
            const tp = sum(arr.map(d => d.promo)), tn = sum(arr.map(d => d.nonpromo)), tt = tp + tn;
            const share = pct(tp, tt).toFixed(1);
            const peakP = arr.reduce((a, b) => a.promo > b.promo ? a : b);
            return `Kontribusi <b>promo</b> ~${share}% dari total. Puncak promo di <b>${bulanID(peakP.bulan)}</b> (${fmtIDR(peakP.promo)} unit).`;
        }
        function ringkasanAkhir() {
            const plain = s => s.replaceAll(/<[^>]+>/g, '');
            const i1 = plain(insightKategori(DATA.kategori));
            const i2 = plain(insightBulanan(DATA.bulanan));
            const i3 = plain(insightTop(DATA.topItem, 3));
            const i4 = plain(insightPenerbit(DATA.penerbit));
            const i5 = plain(insightWeekday(DATA.weekday));
            const i6 = plain(insightPriceBand(DATA.priceBands));
            const i7 = plain(insightPromo(DATA.bulananPromo));
            return `
        <p><b>Inti Temuan:</b> ${i1} ${i2} ${i3} ${i4} ${i5} ${i6} ${i7}</p>
        <p class="muted">
          <span class="kbd">Rekomendasi cepat</span> ·
          (1) Prioritaskan kategori & penerbit unggul; 
          (2) Selaraskan kampanye dengan bulan & hari tersibuk; 
          (3) Optimalkan bundling pada price band favorit; 
          (4) Jadwalkan promosi saat momentum tertinggi.
        </p>
      `;
        }

        /* ======= UPI: Kesimpulan & Tabel Rekomendasi (data-driven) ======= */
        function buildUPIConclusion() {
            const cat = DATA.kategori?.length ? DATA.kategori.reduce((a, b) => a.penjualan > b.penjualan ? a : b) : null;
            const catShare = cat ? pct(cat.penjualan, sum(DATA.kategori, 'penjualan')).toFixed(1) : '—';
            const pub = DATA.penerbit?.length ? DATA.penerbit.reduce((a, b) => a.penjualan > b.penjualan ? a : b) : null;
            const pubShare = pub ? pct(pub.penjualan, sum(DATA.penerbit, 'penjualan')).toFixed(1) : '—';
            const weekBest = DATA.weekday?.length ? DATA.weekday.reduce((a, b) => a.penjualan > b.penjualan ? a : b) : { hari: '—' };
            const peakMonthObj = DATA.bulanan?.length ? DATA.bulanan.reduce((a, b) => a.penjualan > b.penjualan ? a : b) : { bulan: '—', penjualan: 0 };
            const peakMonth = peakMonthObj.bulan !== '—' ? bulanID(peakMonthObj.bulan) : '—';
            const bandTop = DATA.priceBands?.length ? DATA.priceBands.reduce((a, b) => a.penjualan > b.penjualan ? a : b) : { band: '—', penjualan: 0 };
            const promoShare = DATA.bulananPromo?.length ? (() => {
                const tp = sum(DATA.bulananPromo.map(d => d.promo));
                const tn = sum(DATA.bulananPromo.map(d => d.nonpromo));
                return pct(tp, tp + tn).toFixed(1);
            })() : '—';
            return `
        <b>Kesimpulan untuk UPI:</b> fokus kurasi pada kategori <b>${cat ? cat.nama : '—'}</b> (~${catShare}%),
        perkuat kemitraan dengan penerbit <b>${pub ? pub.nama : '—'}</b> (~${pubShare}%),
        jadwalkan aktivasi pada <b>${weekBest.hari}</b> serta momen <b>${peakMonth}</b>,
        tawarkan paket harga pada rentang favorit <b>${bandTop.band}</b>,
        dan manfaatkan skema promo (kontribusi ±<b>${promoShare}%</b>) untuk program kampus.
      `;
        }

        function generateUPIRecommendations() {
            const rows = [];
            const cat = DATA.kategori?.length ? DATA.kategori.reduce((a, b) => a.penjualan > b.penjualan ? a : b) : null;
            const catShare = cat ? pct(cat.penjualan, sum(DATA.kategori, 'penjualan')).toFixed(1) : null;

            const pub = DATA.penerbit?.length ? DATA.penerbit.reduce((a, b) => a.penjualan > b.penjualan ? a : b) : null;
            const pubShare = pub ? pct(pub.penjualan, sum(DATA.penerbit, 'penjualan')).toFixed(1) : null;

            const weekBest = DATA.weekday?.length ? DATA.weekday.reduce((a, b) => a.penjualan > b.penjualan ? a : b) : { hari: '—', penjualan: 0 };
            const weekWorst = DATA.weekday?.length ? DATA.weekday.reduce((a, b) => a.penjualan < b.penjualan ? a : b) : { hari: '—', penjualan: 0 };

            const peakMonthObj = DATA.bulanan?.length ? DATA.bulanan.reduce((a, b) => a.penjualan > b.penjualan ? a : b) : { bulan: '—', penjualan: 0 };
            const peakMonth = peakMonthObj.bulan !== '—' ? bulanID(peakMonthObj.bulan) : '—';

            const bandTop = DATA.priceBands?.length ? DATA.priceBands.reduce((a, b) => a.penjualan > b.penjualan ? a : b) : { band: '—', penjualan: 0 };

            const promoAgg = DATA.bulananPromo?.length ? (() => {
                const tp = sum(DATA.bulananPromo.map(d => d.promo));
                const tn = sum(DATA.bulananPromo.map(d => d.nonpromo));
                const share = pct(tp, tp + tn);
                const peakP = DATA.bulananPromo.reduce((a, b) => a.promo > b.promo ? a : b);
                return { share: share.toFixed(1), peakMonth: bulanID(peakP.bulan), peakVal: tp ? fmtIDR(peakP.promo) : '0' };
            })() : { share: '—', peakMonth: '—', peakVal: '0' };

            const topTitles = [...(DATA.topItem || [])].sort((a, b) => b.penjualan - a.penjualan).slice(0, 3).map(d => d.label).join(', ');

            rows.push({
                fokus: `Kurasi & Display ${cat ? cat.nama : 'Kategori Teratas'}`,
                mitra: "Gramedia (Store Manager), Dosen UPI",
                dasar: cat ? `${cat.nama} menyumbang ~${catShare}% dari total kategori` : "Kategori teratas menyumbang porsi dominan",
                program: `Pojok ${cat ? cat.nama : 'Kategori Teratas'} UPI × Gramedia; list bacaan dosen; bedah buku`,
                kpi: "Uplift penjualan kategori (+10–20%)",
                waktu: peakMonth
            });
            rows.push({
                fokus: `Kemitraan Penerbit (${pub ? pub.nama : 'Penerbit Utama'})`,
                mitra: `${pub ? pub.nama : 'Penerbit Utama'}, Prodi UPI`,
                dasar: pub ? `Kontribusi ~${pubShare}% dari total penerbit` : "Penerbit utama berkontribusi signifikan",
                program: "Kuliah tamu penulis; pre-order kelas; bundling materi ajar",
                kpi: "Jumlah event & PO; sell-through",
                waktu: peakMonth
            });
            rows.push({
                fokus: "Aktivasi Kampus di Hari/Bulan Puncak",
                mitra: "BEM/UKM UPI, Gramedia",
                dasar: `Hari tersibuk: ${weekBest.hari}; tersantai: ${weekWorst.hari}. Puncak: ${peakMonth}`,
                program: "Student Day @store; kelas singkat; diskon khusus mahasiswa",
                kpi: "Traffic & konversi harian",
                waktu: `${weekBest.hari}, ${peakMonth}`
            });
            rows.push({
                fokus: `Bundling Rentang Harga (${bandTop.band})`,
                mitra: "Gramedia, Himpunan Mahasiswa",
                dasar: `Price band terlaris: ${bandTop.band} (${fmtIDR(bandTop.penjualan)} unit)`,
                program: "Paket bundling tematik; kupon kampus",
                kpi: "Average basket size, attach rate",
                waktu: "Selama periode akademik"
            });
            rows.push({
                fokus: "Program Bestseller & Penulis",
                mitra: "Penerbit terkait, Komunitas literasi UPI",
                dasar: `Top judul: ${topTitles || '—'}`,
                program: "Bedah buku, penandatanganan, display premium",
                kpi: "Uplift judul top (+20–30%)",
                waktu: "Sejalan kalender event"
            });
            rows.push({
                fokus: "Skema Promo & Membership Kampus",
                mitra: "Gramedia, Kemahasiswaan UPI",
                dasar: `Kontribusi promo ±${promoAgg.share}% (puncak: ${promoAgg.peakMonth}, ${promoAgg.peakVal} unit)`,
                program: "Kartu anggota kampus; cashback segmen mahasiswa",
                kpi: "Share promo, repeat rate",
                waktu: promoAgg.peakMonth
            });
            rows.push({
                fokus: "Data Sharing + Magang/Riset",
                mitra: "UPI (Prodi terkait), Manajemen Toko",
                dasar: "Kebutuhan pemantauan stok, tren, dan evaluasi program",
                program: "Feed data mingguan; proyek magang analitik; dashboard bersama",
                kpi: "SLA data, jumlah proyek, rekomendasi terimplementasi",
                waktu: "Berjalan (mingguan)"
            });

            return rows;
        }

        function renderUPISection() {
            document.getElementById('upiConclusion').innerHTML = buildUPIConclusion();
            const tbody = document.getElementById('upiTbody');
            tbody.innerHTML = '';
            generateUPIRecommendations().forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
          <td><b>${r.fokus}</b></td>
          <td>${r.mitra}</td>
          <td>${r.dasar}</td>
          <td>${r.program}</td>
          <td>${r.kpi}</td>
          <td>${r.waktu}</td>
        `;
                tbody.appendChild(tr);
            });
        }

        function renderAll() {
            renderKategori();
            renderBulanan();
            renderTop();
            renderPenerbit();
            renderWeekday();
            renderPriceBand();
            renderPromo();

            renderUPIPromoShare();
            renderUPIAfford();
            renderUPITopTitles();
            renderUPIPublishers();

            document.getElementById('insRingkas').innerHTML = ringkasanAkhir();
            renderUPISection();
        }

        // Initial render
        renderAll();

        /* =================== Resize Observer (UX) ==================== */
        const ro = new ResizeObserver(() => {
            if (chartKategori) chartKategori.resize();
            if (chartBulanan) chartBulanan.resize();
            if (chartTop) chartTop.resize();
            if (chartPenerbit) chartPenerbit.resize();
            if (chartWeekday) chartWeekday.resize();
            if (chartPriceBand) chartPriceBand.resize();
            if (chartPromo) chartPromo.resize();
            if (chartUPIPromoShare) chartUPIPromoShare.resize();
            if (chartUPIAfford) chartUPIAfford.resize();
            if (chartUPITopTitles) chartUPITopTitles.resize();
            if (chartUPIPublishers) chartUPIPublishers.resize();
        });
        document.querySelectorAll('.chart-box').forEach(el => ro.observe(el));
    </script>
</body>

</html>